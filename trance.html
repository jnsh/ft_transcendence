<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<title>❤️❤️❤️❤️❤️❤️</title>
	<style>
		body {
			background: #333;
			color: #ddd;
		}

		#main {
			margin: 100px auto;
			max-width: 1024px;
		}

		#pong {
			padding: 4px;
			width: 1024px;
			height: 720px;
			border: 2px solid #ddd;
			background: #111;
		}
	</style>
</head>
<body>
	<div id="main">
		<h1>TRACNE ENERGY 2024</h1>
		<canvas id="pong" width="1024" height="720"></canvas>
	</div>
</body>
</html>

<script>
	const canvas = document.getElementById("pong");
	const ctx = canvas.getContext("2d");

	const padleThic = 10;
	const padleLen = 100;
	const padleSpeed = 4;
	var leftPadleY = (canvas.height - padleLen) / 2;
	var rightPadleY = (canvas.height - padleLen) / 2;

	const ballSize = 10;
	var ballX = 0 + padleThic;
	var ballY = canvas.height / 2;

	var AIballX = ballX;
	var AIballY = ballY;

	const ballSpeed = 5;
	var ballSpeedX = ballSpeed;
	var ballSpeedY = 0;
	var ballDirectionX = 1;
	var ballDirectionY = 1;

	var ballDirection = 0;

	let outputColor = "color:green; font-size:20px;" //delete

	var	scores = [0, 0];

	const levels = [
	{aiError:  10}, // 0:  ai is losing by 10
	{aiError:  20}, // 1:  ai is losing by 9
	{aiError:  30}, // 2:  ai is losing by 8
	{aiError:  40}, // 3:  ai is losing by 7
	{aiError:  50}, // 4:  ai is losing by 6
	{aiError:  60}, // 5:  ai is losing by 5
	{aiError:  70}, // 6:  ai is losing by 4
	{aiError:  80}, // 7:  ai is losing by 3
	{aiError: 90}, // 8:  ai is losing by 2
	{aiError: 100}, // 9:  ai is losing by 1
	{aiError: 110}, // 10:  tie
	{aiError: 120}, // 11:  ai is winning by 1
	{aiError: 130}, // 12: ai is winning by 2
	{aiError: 140}, // 13: ai is winning by 3
	{aiError: 150}, // 14: ai is winning by 4
	{aiError: 160}, // 15: ai is winning by 5
	{aiError: 170}, // 16: ai is winning by 6
	{aiError: 180}, // 17: ai is winning by 7
	{aiError: 190},  // 18: ai is winning by 8
	{aiError: 200},  // 19: ai is winning by 9
	{aiError: 210}  // 20: ai is winning by 10
];

	var pressedKeys = [];
	window.addEventListener('keydown', this.keyPressEvent, false);
	window.addEventListener('keyup', this.keyReleaseEvent, false);

	function keyPressEvent(event) {
		pressedKeys[event.keyCode] = true;
	}

	function keyReleaseEvent(event) {
		pressedKeys[event.keyCode] = false;
	}

	function drawScore() {
		ctx.fillStyle = "#ddd";
		ctx.font = "40px Arial";
		var score = scores[0] + " : " + scores[1];
		ctx.fillText(score, canvas.width / 2 - ctx.measureText(score).width / 2, 50);
	}

	function drawBall() {
		ctx.fillStyle = "#ddd";
		ctx.fillRect(ballX, ballY, ballSize, ballSize);
	}

	function drawLeftPadle() {
		ctx.fillStyle = "#ddd";
		ctx.fillRect(0, leftPadleY, padleThic, padleLen);
	}

	function drawRightPadle() {
		ctx.fillStyle = "#ddd";
		ctx.fillRect(canvas.width - padleThic, rightPadleY, padleThic, padleLen);
	}

	function updateBallPosition() {
		if (ballX <= 0) {
			scores[1]++;
			ballX = canvas.width;
			ballY = canvas.height / 2;
			ballDirection = 1;
		}
		else if (ballX >= canvas.width) {
			scores[0]++;
			ballX = 0 + ballSize;
			ballY = canvas.height / 2;
			ballDirection = 0;
			console.log("%c LOST", "color:green;");
			return ;

		}

		if ((ballX <= padleThic && ballDirectionX == -1) && (ballY + ballSize > leftPadleY && ballY < leftPadleY + padleLen)
			|| (ballX >= canvas.width - padleThic - ballSize && ballDirectionX == 1) && (ballY + ballSize > rightPadleY && ballY < rightPadleY + padleLen)) {
			ballDirectionY = Math.random() < 0.5 ? -1 : 1;
			ballDirectionX *= -1;
			ballSpeedY = Math.floor(Math.random() * ballSpeed);
			ballSpeedX = Math.sqrt((ballSpeed ** 2) - (ballSpeedY ** 2));

			if (ballDirection == 0)
				ballDirection = 1;
			else
				ballDirection = 0;
		}

		if (ballY <= 0 || ballY >= canvas.height - ballSize)
			ballDirectionY *= -1;

		ballX += ballSpeedX * ballDirectionX;
		ballY += ballSpeedY * ballDirectionY;
	}

	function updatePaddlePosition() {
		// W
		if (pressedKeys[87] && leftPadleY > 0)
			leftPadleY -= padleSpeed;
		// S
		if (pressedKeys[83] && leftPadleY < canvas.height - padleLen)
			leftPadleY += padleSpeed;
		// W
		if (pressedKeys[38] && rightPadleY > 0)
			rightPadleY -= padleSpeed;
		// S
		if (pressedKeys[40] && rightPadleY < canvas.height - padleLen)
			rightPadleY += padleSpeed;
	}

	function getRandomNumber(min, max) {
		return (Math.floor(Math.random() * (max - min + 1)) + min);
	}

	function updateAIPaddlePosition(padle) {
		if (ballDirection == 0) {
			var scoreDiff = scores[1] - scores[0];
			var index = Math.max(0, Math.min(levels.length - 1, scoreDiff + 8));
			console.log("index: " + index);
			var level = levels[index];

			var predictedBallY = AIballY + ballSpeedY * ballDirectionY;
			var random = getRandomNumber(-(level.aiError / 2), level.aiError / 2);
			var string = "Predicted ball Y: " + predictedBallY + " Random: " + random;
			predictedBallY += random;
			string += " Predicted ball Y: " + predictedBallY;
			// console.log(string);

			if (predictedBallY < rightPadleY + padleLen / 2 && rightPadleY > 0) {
				rightPadleY -= padleSpeed;
			}
			else if (predictedBallY > rightPadleY + padleLen / 2 && rightPadleY < canvas.height - padleLen) {
				rightPadleY += padleSpeed;
			}
		}
		// else if (ballDirection == 1) {
		// 	var scoreDiff = scores[0] - scores[1];
		// 	var index = Math.max(0, Math.min(levels.length - 1, scoreDiff + 8));
		// 	var level = levels[index];

		// 	var predictedBallY = ballY + ballSpeedY * ballDirectionY;
		// 	predictedBallY += getRandomNumber(-(level.aiError / 2), level.aiError / 2);

		// 	if (predictedBallY < leftPadleY + padleLen / 2  && leftPadleY > 0) {
		// 		leftPadleY -= padleSpeed;
		// 	}
		// 	else if (predictedBallY > leftPadleY + padleLen / 2 && leftPadleY < canvas.height - padleLen) {
		// 		leftPadleY += padleSpeed;
		// 	}
		// }
	}

	function updateAiBallPos()
	{
		AIballX = ballX;
		AIballY = ballY;
	}

	function draw() {
		this.updatePaddlePosition();
		// this.updatePaddlePosition();
		// this.updateLEFTPaddlePosition();
		this.updateAIPaddlePosition();
		this.updateBallPosition();

		ctx.clearRect(0, 0, canvas.width, canvas.height);
		this.drawScore();
		this.drawLeftPadle();
		this.drawRightPadle();
		this.drawBall();
	}

	const interval1 = setInterval(this.draw, 10);
	const interval2 = setInterval(this.updateAiBallPos, 1000);

</script>